# Phase 5-6 Implementation Plan: Git Merge, Nested Teams, CLI & Observability

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Complete the remaining two phases of multi-agent team coordination: git-based workspace merging + nested teams (Phase 5), and CLI/observability extensions (Phase 6).

**Architecture:** Phase 5 adds `workspace_merge` MCP tool (3 strategies via git format-patch/am), nested team support via `CreateSubTeam` vsock RPC with budget inheritance and resource caps. Phase 6 extends CLI with team DAG orchestration, adds `team-status` command, extends ratatui dashboard with team panes, and adds Prometheus team metrics.

**Tech Stack:** Rust, tokio, serde, rmcp, ratatui 0.29, prometheus_client, axum, nftables

---

## Phase 5: Git Merge + Nested Teams

### Task 1: Config — add team resource cap fields

**Files:**
- Modify: `agentiso/src/config.rs:285-322` (DefaultResourceLimits)

**Step 1: Write failing test**

```rust
#[test]
fn team_resource_caps_default() {
    let cfg: DefaultResourceLimits = toml::from_str("").unwrap();
    assert_eq!(cfg.max_total_vms, 100);
    assert_eq!(cfg.max_vms_per_team, 20);
    assert_eq!(cfg.max_nesting_depth, 3);
}
```

**Step 2: Run test to verify it fails**

Run: `cargo test team_resource_caps_default -- --nocapture`
Expected: FAIL — missing fields

**Step 3: Add fields to DefaultResourceLimits**

Add to `DefaultResourceLimits`:
```rust
/// Global hard cap on total VMs across all teams (default 100).
#[serde(default = "default_max_total_vms")]
pub max_total_vms: u32,
/// Maximum VMs per team (default 20).
#[serde(default = "default_max_vms_per_team")]
pub max_vms_per_team: u32,
/// Maximum nesting depth for sub-teams (default 3).
#[serde(default = "default_max_nesting_depth")]
pub max_nesting_depth: u32,
```

Add default functions:
```rust
fn default_max_total_vms() -> u32 { 100 }
fn default_max_vms_per_team() -> u32 { 20 }
fn default_max_nesting_depth() -> u32 { 3 }
```

**Step 4: Run test to verify it passes**

Run: `cargo test team_resource_caps -- --nocapture`
Expected: PASS

**Step 5: Commit**

```bash
git add agentiso/src/config.rs
git commit -m "feat(config): add team resource cap fields (max_total_vms, max_vms_per_team, max_nesting_depth)"
```

---

### Task 2: Protocol — add CreateSubTeam types

**Files:**
- Modify: `protocol/src/lib.rs`

**Step 1: Write failing test**

```rust
#[test]
fn test_create_subteam_roundtrip() {
    let req = GuestRequest::CreateSubTeam(CreateSubTeamRequest {
        name: "sub-team".to_string(),
        parent_team: "parent".to_string(),
        roles: vec![SubTeamRoleDef { name: "coder".to_string(), role: "dev".to_string(), skills: vec![], description: String::new() }],
        max_vms: 5,
    });
    let json = serde_json::to_string(&req).unwrap();
    let decoded: GuestRequest = serde_json::from_str(&json).unwrap();
    // ...
}
```

**Step 2: Run test to verify it fails**

Run: `cargo test -p agentiso-protocol test_create_subteam`

**Step 3: Add protocol types**

Add structs: `CreateSubTeamRequest`, `SubTeamRoleDef`, `SubTeamCreatedResponse`
Add variants: `GuestRequest::CreateSubTeam`, `GuestResponse::SubTeamCreated`

**Step 4: Run tests**

Run: `cargo test -p agentiso-protocol`
Expected: 51+ tests pass

**Step 5: Commit**

```bash
git add protocol/src/lib.rs
git commit -m "feat(protocol): add CreateSubTeam/SubTeamCreated types"
```

---

### Task 3: Team budget tracking + nesting depth enforcement

**Files:**
- Modify: `agentiso/src/team/mod.rs`
- Modify: `agentiso/src/workspace/mod.rs` (TeamState)

**Step 1: Write failing tests**

Tests for:
- Budget deduction when creating sub-team
- Budget returned on sub-team destroy
- Nesting depth exceeded → error
- Global VM cap exceeded → error

**Step 2: Implement TeamBudget struct**

Add `nesting_depth: u32` to `TeamState`.
Add budget enforcement in `create_team()`:
- Check global VM cap: `existing_count + new_count <= config.resources.max_total_vms`
- Check per-team cap: `new_count <= config.resources.max_vms_per_team`
- Check nesting depth: if `parent_team.is_some()`, verify depth < max_nesting_depth
- Deduct from parent's remaining budget if nested

**Step 3: Run tests**

Run: `cargo test team -- --nocapture`

**Step 4: Commit**

```bash
git add agentiso/src/team/mod.rs agentiso/src/workspace/mod.rs
git commit -m "feat(team): budget tracking + nesting depth enforcement"
```

---

### Task 4: workspace_merge MCP tool — sequential strategy

**Files:**
- Modify: `agentiso/src/mcp/git_tools.rs`
- Modify: `agentiso/src/mcp/tools.rs` (register new tool)

**Step 1: Write failing tests**

Test `GitMergeParams` serde:
```rust
#[test]
fn test_git_merge_params() {
    let json = json!({
        "source_workspaces": ["ws-1", "ws-2"],
        "target_workspace": "ws-target",
        "strategy": "sequential",
    });
    let params: GitMergeParams = serde_json::from_value(json).unwrap();
    assert_eq!(params.strategy, "sequential");
    assert_eq!(params.source_workspaces.len(), 2);
}
```

**Step 2: Implement handle_workspace_merge()**

1. Resolve all workspace IDs (source + target)
2. Check ownership of target
3. For each source:
   a. `exec("git format-patch --stdout HEAD~..HEAD")` to extract patch
   b. Transfer patch via file_write to target
   c. In target: `exec("git am /tmp/patch-{source}.patch")`
4. Return merge result with conflict details if `git am` fails

**Step 3: Register tool in tools.rs dispatch**

Add `"workspace_merge"` → `handle_workspace_merge` in tool dispatch.

**Step 4: Run tests**

Run: `cargo test git_merge -- --nocapture`

**Step 5: Commit**

```bash
git add agentiso/src/mcp/git_tools.rs agentiso/src/mcp/tools.rs
git commit -m "feat(mcp): workspace_merge tool with sequential strategy"
```

---

### Task 5: workspace_merge — branch-per-source + cherry-pick strategies

**Files:**
- Modify: `agentiso/src/mcp/git_tools.rs`

**Step 1: Write tests for each strategy**

**Step 2: Implement branch-per-source**

1. For each source, create branch `merge/{source-name}` in target
2. Apply patches to that branch
3. Merge branches into main: `git merge merge/{source-name}`
4. If conflicts, return details per-branch

**Step 3: Implement cherry-pick**

1. For each source, get commit list: `git log --format=%H`
2. Cherry-pick each commit: `git cherry-pick {hash}`
3. On conflict, report which commit and files conflict

**Step 4: Run tests**

Run: `cargo test workspace_merge -- --nocapture`

**Step 5: Commit**

```bash
git add agentiso/src/mcp/git_tools.rs
git commit -m "feat(mcp): workspace_merge branch-per-source + cherry-pick strategies"
```

---

### Task 6: Nested team nftables rules

**Files:**
- Modify: `agentiso/src/network/nftables.rs`

**Step 1: Write failing tests**

Test parent-child team communication rules:
- Parent members can reach child members
- Child members can reach parent members (bidirectional)
- Sibling sub-teams are isolated from each other
- Network policy inheritance: child cannot escalate parent's restrictions

**Step 2: Implement nested team rules**

Add `apply_nested_team_rules(parent_team, child_team, parent_ips, child_ips)`:
- Generate bidirectional rules between parent and child member IPs
- Use comment prefix `team-{parent}-child-{child}-` for cleanup
- Respect parent's `allow_inter_vm` setting

Add `remove_nested_team_rules(parent_team, child_team)`.

**Step 3: Wire into team creation**

In `team/mod.rs::create_team()`, when `parent_team.is_some()`:
- Get parent member IPs
- Call `nw.nftables().apply_nested_team_rules(parent, child, parent_ips, child_ips)`

**Step 4: Run tests**

Run: `cargo test nftables -- --nocapture`

**Step 5: Commit**

```bash
git add agentiso/src/network/nftables.rs agentiso/src/team/mod.rs
git commit -m "feat(network): nested team nftables rules with parent-child isolation"
```

---

### Task 7: Guest-side CreateSubTeam handler

**Files:**
- Modify: `guest-agent/src/main.rs`

**Step 1: Add match arm in handle_request()**

```rust
GuestRequest::CreateSubTeam(req) => handle_create_subteam(req).await,
```

**Step 2: Implement handle_create_subteam()**

The guest agent forwards this request to the host via vsock. The host's VmManager handles it by calling TeamManager::create_team() with parent_team set.

Return `GuestResponse::SubTeamCreated` with team name and member info.

**Step 3: Run tests**

Run: `cargo test -p agentiso-guest`

**Step 4: Commit**

```bash
git add guest-agent/src/main.rs
git commit -m "feat(guest): CreateSubTeam vsock handler"
```

---

### Task 8: Phase 5 integration tests + docs

**Files:**
- Modify: `scripts/test-mcp-integration.sh`
- Modify: `docs/tools.md`
- Modify: `CLAUDE.md`
- Modify: `AGENTS.md`

**Steps:**
1. Add integration test steps for workspace_merge (create 2 workspaces, clone repos, make changes, merge)
2. Add integration test steps for nested team creation (create parent, create sub-team, verify budget, destroy parent cascades)
3. Update docs/tools.md with workspace_merge tool reference
4. Update CLAUDE.md test counts and Phase 5 status
5. Update AGENTS.md Phase 5 completion

**Commit:**

```bash
git commit -m "feat: Phase 5 complete — workspace_merge + nested teams + budget enforcement"
```

---

## Phase 6: CLI + Observability

### Task 9: Prometheus team metrics

**Files:**
- Modify: `agentiso/src/mcp/metrics.rs`

**Step 1: Write failing tests**

```rust
#[test]
fn team_metrics_recording() {
    let registry = MetricsRegistry::new();
    registry.record_team_created("my-team");
    registry.record_message_sent("my-team", "text");
    // verify via render()
}
```

**Step 2: Add team metrics**

- `agentiso_teams_total` (gauge by state)
- `agentiso_team_messages_total` (counter by team, type)
- `agentiso_team_tasks_total` (counter by team, status)
- `agentiso_merge_total` (counter by strategy, result)
- `agentiso_merge_duration_seconds` (histogram)

**Step 3: Add recording methods**

- `record_team_created(team: &str)`
- `record_team_destroyed(team: &str)`
- `record_message_sent(team: &str, msg_type: &str)`
- `record_merge(strategy: &str, success: bool, duration: Duration)`

**Step 4: Run tests**

Run: `cargo test metrics -- --nocapture`

**Step 5: Commit**

```bash
git add agentiso/src/mcp/metrics.rs
git commit -m "feat(metrics): add team operation Prometheus metrics"
```

---

### Task 10: team-status CLI command

**Files:**
- Modify: `agentiso/src/main.rs`

**Step 1: Add TeamStatus subcommand**

```rust
/// Show team status overview.
TeamStatus {
    /// Team name.
    team_name: String,
    #[arg(long, short)]
    config: Option<PathBuf>,
}
```

**Step 2: Implement handler**

Load config → create WorkspaceManager → create TeamManager → call `team_status()` → pretty-print table with team name, state, members (name, IP, workspace state, agent status).

**Step 3: Run `cargo check`**

**Step 4: Commit**

```bash
git add agentiso/src/main.rs
git commit -m "feat(cli): add team-status subcommand"
```

---

### Task 11: Orchestrate team DAG execution

**Files:**
- Modify: `agentiso/src/workspace/orchestrate.rs`

**Step 1: Write failing tests**

```rust
#[test]
fn team_plan_dag_cycle_detection() {
    // task A depends on B, B depends on A → error
}

#[test]
fn team_plan_topological_sort() {
    // A→B→C → execution order: A, B, C
}
```

**Step 2: Add TeamPlan + TeamTaskDef structs**

```rust
#[derive(Deserialize)]
pub struct TeamPlan {
    pub team_name: String,
    pub roles: Vec<RoleDef>,
    pub tasks: Vec<TeamTaskDef>,
}

#[derive(Deserialize)]
pub struct TeamTaskDef {
    pub name: String,
    pub prompt: String,
    pub assigned_to: Vec<String>,
    #[serde(default)]
    pub depends_on: Vec<String>,
    pub workdir: Option<String>,
    pub vault_context: Option<Vec<VaultQuery>>,
}
```

**Step 3: Implement DAG validation + topological sort**

Use Kahn's algorithm (same pattern as TaskBoard::dependency_order).

**Step 4: Implement team execution function**

Fork team → dispatch tasks in dependency order → collect results.

**Step 5: Run tests**

Run: `cargo test orchestrate -- --nocapture`

**Step 6: Commit**

```bash
git add agentiso/src/workspace/orchestrate.rs
git commit -m "feat(orchestrate): team DAG execution with depends_on"
```

---

### Task 12: Dashboard team pane — data loading

**Files:**
- Modify: `agentiso/src/dashboard/data.rs`
- Modify: `agentiso/src/dashboard/mod.rs`

**Step 1: Add TeamDashboardData struct**

```rust
pub struct TeamDashboardData {
    pub teams: Vec<TeamSummary>,
    pub selected_team: Option<TeamDetail>,
}

pub struct TeamSummary {
    pub name: String,
    pub state: String,
    pub member_count: usize,
    pub created_at: String,
}

pub struct TeamDetail {
    pub members: Vec<MemberRow>,
    pub messages: Vec<MessageRow>,
    pub task_summary: TaskSummary,
}
```

**Step 2: Add team loading to DashboardData::load()**

**Step 3: Add team mode to App struct**

Add `team_mode: bool`, `team_data: Option<TeamDashboardData>`, key handler for 't' toggle.

**Step 4: Run cargo check**

**Step 5: Commit**

```bash
git add agentiso/src/dashboard/data.rs agentiso/src/dashboard/mod.rs
git commit -m "feat(dashboard): team data model + loading"
```

---

### Task 13: Dashboard team pane — UI rendering

**Files:**
- Modify: `agentiso/src/dashboard/ui.rs`

**Step 1: Add team pane rendering functions**

- `draw_team_header()`: team name, state, member count
- `draw_team_members()`: table with agent name, status, IP, workspace state
- `draw_team_messages()`: scrollable message log
- `draw_team_tasks()`: task board summary

**Step 2: Update draw_middle() for team mode**

When `app.team_mode`, render team panes instead of workspace panes.

**Step 3: Add tab navigation**

Tab/Shift-Tab to cycle between Members, Tasks, Messages sub-panes.

**Step 4: Run cargo check**

**Step 5: Commit**

```bash
git add agentiso/src/dashboard/ui.rs
git commit -m "feat(dashboard): team pane UI rendering"
```

---

### Task 14: Phase 6 integration tests + final docs update

**Files:**
- Modify: `scripts/test-mcp-integration.sh`
- Modify: `docs/tools.md`
- Modify: `CLAUDE.md`
- Modify: `AGENTS.md`

**Steps:**
1. Update all test counts
2. Update tool reference docs with workspace_merge
3. Final CLAUDE.md status update — all phases complete
4. AGENTS.md — mark all 6 phases complete

**Commit:**

```bash
git commit -m "docs: Phase 6 complete — CLI, dashboard, metrics, all phases done"
```

---

## Agent Assignments

| Task | Agent | Rationale |
|------|-------|-----------|
| 1. Config resource caps | workspace-core | Owns config.rs |
| 2. Protocol types | guest-agent | Owns protocol/ |
| 3. Budget + nesting | workspace-core | Owns team/mod.rs, workspace/ |
| 4-5. workspace_merge | mcp-server | Owns mcp/git_tools.rs |
| 6. Nested nftables | storage-net | Owns network/nftables.rs |
| 7. Guest handler | guest-agent | Owns guest-agent/ |
| 8. Phase 5 tests+docs | lead | Integration across all |
| 9. Prometheus metrics | mcp-server | Owns mcp/metrics.rs |
| 10. team-status CLI | workspace-core | Owns main.rs |
| 11. DAG orchestrate | workspace-core | Owns orchestrate.rs |
| 12-13. Dashboard | workspace-core | Owns dashboard/ |
| 14. Phase 6 tests+docs | lead | Integration across all |

## Dependency Graph

```
Phase 5:
  Task 1 (config) ──┐
  Task 2 (protocol) ─┼──→ Task 3 (budget) ──→ Task 6 (nftables) ──→ Task 8 (tests)
                     │                    └──→ Task 7 (guest handler)───┘
                     └──→ Task 4 (merge seq) → Task 5 (merge all) ──→ Task 8
Phase 6:
  Task 9 (metrics) ──→ Task 14 (docs)
  Task 10 (CLI) ──────→ Task 14
  Task 11 (DAG) ──────→ Task 14
  Task 12 (dash data) → Task 13 (dash UI) → Task 14
```
